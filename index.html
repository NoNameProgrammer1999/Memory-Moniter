<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/svg+xml"
href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%' y='70%' text-anchor='middle' font-size='80'>‚ù§Ô∏è</text></svg>">

<title>Memory Moniter</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap');

body{
  font-family:'Zen Maru Gothic',sans-serif;
  background:linear-gradient(180deg,#fffaf3,#ffeef2);
  margin:0;
}

header{
  text-align:center;
  padding:24px;
  background:#ffffffcc;
}

.container{max-width:900px;margin:auto;padding:20px;}

.form-box{
  background:#fff;
  padding:20px;
  border-radius:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

input,textarea{
  width:100%;
  margin-bottom:12px;
  padding:10px;
  border-radius:12px;
  border:1px solid #f0d7df;
}

button{
  background:#e97aa2;
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:999px;
  cursor:pointer;
}

.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:20px;
  margin-top:30px;
}

.card{
  position:relative;
  background:#fff;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 10px 26px rgba(0,0,0,.08);
}

.card img{
  width:100%;
  height:200px;
  object-fit:cover;
  cursor:pointer;
}

.delete{
  position:absolute;
  top:8px;
  right:8px;
  background:#fff;
  border:none;
  border-radius:50%;
  width:30px;
  height:30px;
  cursor:pointer;
  font-size:16px;
}

.text{padding:14px}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal img{
  max-width:90%;
  max-height:90%;
  border-radius:20px;
}
</style>
</head>

<body>

<header>
  <h1>üíñ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</h1>
  <p id="anniversary"></p>
  <p id="countdown"></p>
</header>

<div class="container">

<div class="form-box">
  <input type="file" id="imageInput" accept="image/*">
  <textarea id="textInput" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥..."></textarea>
  <button onclick="addMemory()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<div class="gallery" id="gallery"></div>
</div>

<div class="modal" id="modal" onclick="closeModal()">
  <img id="modalImg">
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbz44wxO2IImpFOxM9D_kRYnGr8eKZjxejBz2w_1Q-bwcFu0LHnyoIvUGzH2scHmAcANQA/exec';

/* ===== IMAGE COMPRESS ===== */
function compressImage(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const scale = Math.min(1, 800 / img.width);
        c.width = img.width * scale;
        c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        res(c.toDataURL('image/jpeg', 0.7));
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}

/* ===== ADD MEMORY ===== */
window.addMemory = async function () {
  const fileInput = document.getElementById('imageInput');
  const textInput = document.getElementById('textInput');
  const img = fileInput.files[0];

  if (!img) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }

  const imageData = await compressImage(img);

  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      image: imageData,
      text: textInput.value
    })
  });

  fileInput.value = '';
  textInput.value = '';
  loadFromAPI();
};

/* ===== DELETE ===== */
window.deleteMemory = async function(id){
  if(!confirm('‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ô‡∏µ‡πâ?')) return;

  await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:'delete',
      id:id
    })
  });

  loadFromAPI();
};

/* ===== MODAL ===== */
window.openModal = function(src){
  document.getElementById('modalImg').src = src;
  document.getElementById('modal').style.display = 'flex';
};
window.closeModal = function(){
  document.getElementById('modal').style.display = 'none';
};

/* ===== JSONP LOAD ===== */
window.loadMemories = function(data){
  const gallery = document.getElementById('gallery');
  if (!gallery) return;

  gallery.innerHTML='';
  data.reverse().forEach(d=>{
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`
      <button class="delete" onclick="deleteMemory('${d.id}')">üóë</button>
      <img src="${d.image}" onclick="openModal(this.src)">
      <div class="text">${d.text}</div>
    `;
    gallery.appendChild(c);
  });
};

function loadFromAPI(){
  const old = document.getElementById('jsonp');
  if(old) old.remove();

  const s = document.createElement('script');
  s.id = 'jsonp';
  s.src = API_URL + '?callback=loadMemories';

  (document.body || document.documentElement).appendChild(s);
}

/* ===== START AFTER DOM READY ===== */
document.addEventListener('DOMContentLoaded', () => {
  loadFromAPI();
});
</script>


</body>
</html>
