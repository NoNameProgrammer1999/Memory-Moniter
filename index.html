<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbz44wxO2IImpFOxM9D_kRYnGr8eKZjxejBz2w_1Q-bwcFu0LHnyoIvUGzH2scHmAcANQA/exec';
const gallery = document.getElementById('gallery');

/* ===== IMAGE COMPRESS ===== */
function compressImage(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement('canvas');
        const scale = Math.min(1, 800 / img.width);
        c.width = img.width * scale;
        c.height = img.height * scale;
        c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
        res(c.toDataURL('image/jpeg', 0.7));
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}

/* ===== ADD MEMORY (FIXED) ===== */
window.addMemory = async function () {
  const fileInput = document.getElementById('imageInput');
  const textInput = document.getElementById('textInput');
  const img = fileInput.files[0];

  if (!img) {
    alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸à¹ˆà¸­à¸™');
    return;
  }

  const imageData = await compressImage(img);

  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      image: imageData,
      text: textInput.value
    })
  });

  // reset form
  fileInput.value = '';
  textInput.value = '';

  loadFromAPI();
};

/* ===== DELETE ===== */
window.deleteMemory = async function(id){
  if(!confirm('à¸¥à¸šà¸„à¸§à¸²à¸¡à¸—à¸£à¸‡à¸ˆà¸³à¸™à¸µà¹‰?')) return;

  await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      action:'delete',
      id:id
    })
  });

  loadFromAPI();
};

/* ===== MODAL ===== */
window.openModal = function(src){
  document.getElementById('modalImg').src = src;
  document.getElementById('modal').style.display = 'flex';
};
window.closeModal = function(){
  document.getElementById('modal').style.display = 'none';
};

/* ===== JSONP LOAD ===== */
window.loadMemories = function(data){
  gallery.innerHTML='';
  data.reverse().forEach(d=>{
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`
      <button class="delete" onclick="deleteMemory('${d.id}')">ðŸ—‘</button>
      <img src="${d.image}" onclick="openModal(this.src)">
      <div class="text">${d.text}</div>
    `;
    gallery.appendChild(c);
  });
};

function loadFromAPI(){
  const old=document.getElementById('jsonp');
  if(old) old.remove();
  const s=document.createElement('script');
  s.id='jsonp';
  s.src=API_URL+'?callback=loadMemories';
  document.body.appendChild(s);
}

loadFromAPI();
</script>
