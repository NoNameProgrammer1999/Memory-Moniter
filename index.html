<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/svg+xml"
href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%' y='70%' text-anchor='middle' font-size='80'>‚ù§Ô∏è</text></svg>">

<title>Memory Gallery</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap');

body{
  font-family:'Zen Maru Gothic',sans-serif;
  background:linear-gradient(180deg,#fffaf3,#ffeef2);
  margin:0;
}

header{
  text-align:center;
  padding:24px;
  background:#ffffffcc;
}

.container{max-width:900px;margin:auto;padding:20px;}

.form-box{
  background:#fff;
  padding:20px;
  border-radius:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

.form-box input,textarea{
  width:100%;
  margin-bottom:12px;
  padding:10px;
  border-radius:12px;
  border:1px solid #f0d7df;
}

button{
  background:#e97aa2;
  color:#fff;
  border:none;
  padding:12px 20px;
  border-radius:999px;
  cursor:pointer;
}

.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:20px;
  margin-top:30px;
}

.card{
  background:#fff;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 10px 26px rgba(0,0,0,.08);
}

.card img{
  width:100%;
  height:200px;
  object-fit:cover;
}

.text{padding:14px;}
</style>
</head>

<body>

<header>
  <h1>üíñ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</h1>
  <p id="anniversary"></p>
  <p id="countdown"></p>
</header>

<div class="container">

<div class="form-box">
  <input type="file" id="imageInput" accept="image/*">
  <textarea id="textInput" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥..."></textarea>
  <button onclick="addMemory()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<div class="gallery" id="gallery"></div>

</div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyxmqOjWHyHcTpr1fg71d5fguQ8zHsdDMu68v0U-fXuLEC9kx4aKmsWdmajsopqpzIt5w/exec';
const gallery = document.getElementById('gallery');

/* ===== ANNIVERSARY ===== */
const startDate = new Date(2022,10,18);

function updateAnniversary(){
  const now = new Date();
  let years = now.getFullYear() - startDate.getFullYear();
  if(now < new Date(now.getFullYear(),10,18)) years--;

  const last = new Date(startDate.getFullYear()+years,10,18);
  const diff = now-last;

  document.getElementById('anniversary').textContent =
   `‡∏Ñ‡∏ö‡∏Å‡∏±‡∏ô‡∏°‡∏≤ ${years} ‡∏õ‡∏µ ${Math.floor(diff/86400000)} ‡∏ß‡∏±‡∏ô`;

  const next = new Date(last.getFullYear()+1,10,18);
  const left = next-now;
  document.getElementById('countdown').textContent =
   `‡∏≠‡∏µ‡∏Å ${Math.floor(left/86400000)} ‡∏ß‡∏±‡∏ô ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤ üíï`;
}
setInterval(updateAnniversary,1000);
updateAnniversary();

/* ===== JSONP ===== */
window.loadMemories = function(data){
  gallery.innerHTML='';
  data.reverse().forEach(d=>{
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`<img src="${d.image}"><div class="text">${d.text}</div>`;
    gallery.appendChild(c);
  });
};

function loadFromAPI(){
  const s=document.createElement('script');
  s.src=API_URL+'?callback=loadMemories';
  document.body.appendChild(s);
}

/* ===== IMAGE COMPRESS ===== */
function compressImage(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement('canvas');
        const scale=Math.min(1,800/img.width);
        c.width=img.width*scale;
        c.height=img.height*scale;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        res(c.toDataURL('image/jpeg',0.7));
      };
      img.src=e.target.result;
    };
    r.readAsDataURL(file);
  });
}

/* ===== ADD MEMORY ===== */
window.addMemory = async function(){
  const img=document.getElementById('imageInput').files[0];
  if(!img){alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');return;}

  const imageData=await compressImage(img);
  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({
      image:imageData,
      text:document.getElementById('textInput').value
    })
  }).then(()=>{
    loadFromAPI();
    document.getElementById('imageInput').value='';
    document.getElementById('textInput').value='';
  });
};

loadFromAPI();
</script>

</body>
</html>

